{
  "name": "Processamento - Gold",
  "nodes": [
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  const raw = item.json.raw_data; \n\n  // Datas\n  const inicio = new Date(raw.created_at);\n  const fim = new Date(raw.updated_at);\n  const duracaoMinutos = (fim - inicio) / 1000 / 60;\n\n  // Mapas de Tradução\n  const tipoMap = { \n    \"COMPANY\": \"EMPRESA\",\n    \"PERSON\": \"PESSOA\"\n  };\n  const statusMap = {\n    \"COMPLETED\": \"CONCLUIDO\",\n    \"PROCESSING\": \"EM_PROCESSAMENTO\",\n    \"FAILED\": \"FALHOU\",\n    \"CANCELED\": \"CANCELADO\"\n  };\n\n  // Categorização de Tamanho\n  let tamanho = \"PEQUENO\";\n  if (raw.total_contacts > 1000) \n    tamanho = \"MUITO_GRANDE\";\n  else if (raw.total_contacts > 500) \n    tamanho = \"GRANDE\";\n  else if (raw.total_contacts > 100) \n    tamanho = \"MEDIO\";\n   \n  return {\n    json: {\n      // Mapeamento De -> Para\n      id_enriquecimento: raw.id,\n      id_workspace: raw.id_workspace,\n      nome_workspace: raw.workspace_name,\n      total_contatos: raw.total_contacts,\n      \n      // Traduções\n      tipo_contato: tipoMap[raw.contact_type] || raw.contact_type,\n      status_processamento: statusMap[raw.status] || raw.status,\n      \n      // Datas\n      data_criacao: raw.created_at,\n      data_atualizacao: raw.updated_at,\n\n      // Cálculos\n      duracao_processamento_minutos: parseFloat(duracaoMinutos.toFixed(2)),\n      tempo_por_contato_minutos: raw.total_contacts > 0 ? parseFloat((duracaoMinutos / raw.total_contacts).toFixed(4)) : 0,\n      \n      // Lógica Booleana\n      processamento_sucesso: raw.status === \"COMPLETED\",\n      categoria_tamanho_job: tamanho,\n      necessita_reprocessamento: ['FAILED', 'CANCELED'].includes(raw.status),\n      \n      // Carimbo do DW\n      data_atualizacao_dw: new Date().toISOString()\n    }\n  }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        0
      ],
      "id": "e16aae1d-6d49-41da-80cf-20ead776f495",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "gold_enrichments",
          "mode": "list",
          "cachedResultName": "gold_enrichments"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {
            "processamento_sucesso": false,
            "necessita_reprocessamento": false
          },
          "matchingColumns": [
            "id_enriquecimento"
          ],
          "schema": [
            {
              "id": "id_enriquecimento",
              "displayName": "id_enriquecimento",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "id_workspace",
              "displayName": "id_workspace",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "nome_workspace",
              "displayName": "nome_workspace",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "total_contatos",
              "displayName": "total_contatos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "tipo_contato",
              "displayName": "tipo_contato",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status_processamento",
              "displayName": "status_processamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "data_criacao",
              "displayName": "data_criacao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "data_atualizacao",
              "displayName": "data_atualizacao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "duracao_processamento_minutos",
              "displayName": "duracao_processamento_minutos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "tempo_por_contato_minutos",
              "displayName": "tempo_por_contato_minutos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "processamento_sucesso",
              "displayName": "processamento_sucesso",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "categoria_tamanho_job",
              "displayName": "categoria_tamanho_job",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "necessita_reprocessamento",
              "displayName": "necessita_reprocessamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "data_atualizacao_dw",
              "displayName": "data_atualizacao_dw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        624,
        0
      ],
      "id": "a1e61401-3b12-4032-b7bb-495f4b423fb4",
      "name": "Insert or update rows in a table",
      "credentials": {
        "postgres": {
          "id": "LIK2l2Kt3l2FRQCy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "bronze_enrichments",
          "mode": "list",
          "cachedResultName": "bronze_enrichments"
        },
        "limit": 10000,
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        208,
        0
      ],
      "id": "93c9f997-d384-42e5-ace8-eb5e96d2b9e1",
      "name": "Select rows from a table",
      "credentials": {
        "postgres": {
          "id": "LIK2l2Kt3l2FRQCy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "8563875a-e441-4cd9-a989-8e70fc23b63a",
      "name": "When Executed by Another Workflow"
    }
  ],
  "pinData": {},
  "connections": {
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Insert or update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select rows from a table": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Select rows from a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "1ed4388c-161c-4904-bf65-b09ba21e258d",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2e7acdf635fbf04d338901d7968a68094f26239b67a2b6a57e7c894de2f22233"
  },
  "id": "Ec94mHd4YAcD8H7KJOPXn",
  "tags": []
}